<!doctype html>
<html>

<head>
    <title>Converting a raw BJS scene to _runtime</title>
    <meta charset="UTF-8">
    <script src="js/babylon.js"></script>
    <script src="js/pep.min.js"></script>
    <script src="js/_r.min.js"></script>
    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: tahoma, arial, sans-serif;
            color: white;
        }
    </style>
</head>

<body>
    <script type="text/javascript">
        _r.launch({
            scene: "assets/scene-BJS.babylon",
            patch: [
                "assets/patches/scene.patch",
                "assets/patches/cameras.patch",
                "assets/patches/tweaks.patch",
            ]
        });

        _r.ready(function () {

            BABYLON.DebugLayer.InspectorURL = "js/babylon.inspector.bundle.js";
            _r.scene.debugLayer.show({
                overlay: true,
                embedMode: true,
                enablePopup: true
            });

            _r.activateCamera("arcRotateCamera");

            /** LIGHTMAP ASSIGNATION PROCESS **/

            /*           
             _r.patch([{
                "*wallz*:mesh, *furnitures.000:mesh": {
                    "lightmapTexture": function (mesh) {
                        return _r.load.texture("assets/lightmaps/" + mesh.name + "_LM.jpg");
                    }
                }
            }]);
*/

            _r.patch([{
                "*wall*:mesh": {
                    material: {
                        subMaterials: {
                            "*": {
                                "lightmapTexture": function (submtl, test2, test3) {
                                    console.log("yep yep yep", submtl, test2, test3)
                                    return _r.load.texture("assets/lightmaps/wallz.000_LM.jpg", {
                                        coordinatesIndex: 1
                                    });
                                },
                                "useLightmapAsShadowmap": true
                            }
                        }
                    }
                }
            }]);

            /*
                                    _r.patch([{
                                        "*wall*:material": {
                                            "lightmapTexture": function () {
                                                return _r.load.texture("assets/lightmaps/wallz.000_LM.jpg", {
                                                    coordinatesIndex: 1
                                                });
                                            },
                                            "useLightmapAsShadowmap": true
                                        }
                                    }]);

            */
            /*
                        _r.load.texture("assets/lightmaps/wallz.000_LM.jpg", {
                            coordinatesIndex: 1
                        }).then(function (texture) {
                            _r.patch([{
                                "*wall*:material": {
                                    "lightmapTexture": function () {
                                        return texture
                                    },
                                    "useLightmapAsShadowmap": true
                                }
                            }]);
                        });
            */
            /*

            function assignLightmapOnMaterial(material, lightmap) {
                material.lightmapTexture = lightmap;
                // we want using UV2
                material.lightmapTexture.coordinatesIndex = 1;
                // our lightmap workflow is a darken one
                material.useLightmapAsShadowmap = true;
            }

            // lightmapped meshes list
            var lightmappedMeshes = ["wallz.000", "furnitures.000"];
            // we start cycling through them
            for (var i = 0; i < lightmappedMeshes.length; i++) {
                var currentMesh = _r.scene.getMeshByName(lightmappedMeshes[i]);
                // lightmap loading
                var currentMeshLightmap = new BABYLON.Texture(
                    "assets/lightmaps/" + currentMesh.name + "_LM.jpg",
                    _r.scene
                );
                currentMeshLightmap.name = currentMesh.name + "_LM";
                // we start cycling through each mesh material(s)
                if (!currentMesh.material) {
                    // no material so skipping
                    continue;
                } else if (!currentMesh.material.subMaterials) {
                    // no subMaterials
                    assignLightmapOnMaterial(currentMesh.material, currentMeshLightmap);
                } else if (currentMesh.material.subMaterials) {
                    // we cycle through subMaterials
                    for (var j = 0; j < currentMesh.material.subMaterials.length; j++) {
                        assignLightmapOnMaterial(currentMesh.material.subMaterials[j], currentMeshLightmap);
                    }
                }
            }

            */

        });
    </script>
</body>

</html>