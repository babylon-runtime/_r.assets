<!doctype html>
<html>

<head>
    <title>Converting a raw BJS scene to _runtime</title>
    <meta charset="UTF-8">
    <script src="js/babylon.js"></script>
    <script src="js/pep.min.js"></script>
    <script src="js/_r.min.js"></script>
    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: tahoma, arial, sans-serif;
            color: white;
        }

        #canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <script type="text/javascript">
        _r.launch({
            scene: "assets/scene-BJS.babylon",
            activeCamera: function () {
                return new BABYLON.ArcRotateCamera("arcRotateCamera", 1, 1, 1, BABYLON.Vector3.Zero(),
                    _r.scene);
            },
            patch: [
                "assets/patches/scene.patch",
                "assets/patches/cameras.patch",
                "assets/patches/tweaks.patch",
            ]
        });

        _r.ready(function () {

            /** LIGHTMAP ASSIGNATION PROCESS **/

            function assignLightmapOnMaterial(material, lightmap) {
                material.lightmapTexture = lightmap;
                // we want using UV2
                material.lightmapTexture.coordinatesIndex = 1;
                // our lightmap workflow is a darken one
                material.useLightmapAsShadowmap = true;
            }

            // lightmapped meshes list
            var lightmappedMeshes = ["wallz.000", "furnitures.000"];
            // we start cycling through them
            for (var i = 0; i < lightmappedMeshes.length; i++) {
                var currentMesh = _r.scene.getMeshByName(lightmappedMeshes[i]);
                // lightmap loading
                var currentMeshLightmap = new BABYLON.Texture(
                    "assets/lightmaps/" + currentMesh.name + "_LM.jpg",
                    _r.scene
                );
                currentMeshLightmap.name = currentMesh.name + "_LM";
                // we start cycling through each mesh material(s)
                if (!currentMesh.material) {
                    // no material so skipping
                    continue;
                } else if (!currentMesh.material.subMaterials) {
                    // no subMaterials
                    assignLightmapOnMaterial(currentMesh.material, currentMeshLightmap);
                } else if (currentMesh.material.subMaterials) {
                    // we cycle through subMaterials
                    for (var j = 0; j < currentMesh.material.subMaterials.length; j++) {
                        assignLightmapOnMaterial(currentMesh.material.subMaterials[j], currentMeshLightmap);
                    }
                }
            }
        });
    </script>
</body>

</html>